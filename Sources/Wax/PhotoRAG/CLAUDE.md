# Sources/Wax/PhotoRAG Module

## Purpose
On-device, offline-only RAG over a user's Photos library. Ingests `PHAsset`s, extracts metadata/OCR/captions, computes multimodal embeddings, and returns RAG-ready context with text surrogates and optional pixel payloads (thumbnails/region crops).

## Key Types

| Type | Role |
|------|------|
| `PhotoRAGOrchestrator` | Actor. Owns a `Wax` store and `WaxSession`. Manages ingest, recall, delete, and the in-memory index. |
| `PhotoRAGConfig` | Struct. Host-tunable config: pixel sizes, OCR toggle, region count, search topK, hybrid alpha, thumbnail/crop output, embedding cache size. |
| `PhotoQuery` | Struct. Query parameters: text, image, time range, location, filters, result limit, context budget. |
| `PhotoRAGContext` | Struct. Recall output: items + diagnostics (used tokens, degraded count). |
| `PhotoRAGItem` | Struct. Per-photo result: assetID, score, evidence attribution, summary text, optional thumbnail/regions. |
| `ContextBudget` | Struct. Token/image/region caps for context assembly. |
| `PhotoNormalizedRect` | Struct. `[0,1]` normalized rect with top-left origin. |
| `PhotoQueryImage` / `PhotoPixel` | Sendable wrappers for query-time and result-time image data. |
| `OCRProvider` | Protocol. On-device text recognition returning `[RecognizedTextBlock]`. |
| `CaptionProvider` | Protocol. On-device image captioning. |
| `VisionOCRProvider` | Struct. Default OCR using Apple Vision framework (`VNRecognizeTextRequest`). |
| `PhotosAssetMetadata` | Enum (namespace). Loads PHAsset metadata + image bytes offline-only. Extracts EXIF. |

## Frame Kind Hierarchy

```
photo.root          -- One per asset. Holds global embedding + metadata.
photo.ocr.block     -- One per OCR text block. Stores text + bbox. Not text-indexed.
photo.ocr.summary   -- Concatenated OCR summary. Text-indexed for search.
photo.caption.short  -- Short caption (host-supplied or weak fallback). Text-indexed.
photo.tags          -- Tag list. Text-indexed.
photo.region        -- Crop region with its own embedding. Used for spatial matching.
system.photos.sync_state -- Sync state marker.
```

## Architecture Decisions

### Location Binning
GPS coordinates are binned at 0.01-degree resolution (~1.1km): `Int(floor(lat * 100.0))`. Location queries scan all bins within the radius and build a frame ID allowlist for the search engine.

### Metadata-Only Degradation
When `PHImageRequestOptions.isNetworkAccessAllowed = false` and the asset is iCloud-only, Wax writes a metadata-only root (no embedding, no OCR). These are indexed but marked degraded in diagnostics.

### Supersede-Not-Delete
Re-ingesting an asset creates a new root and supersedes the old one. Old frames remain for audit; superseded roots are filtered from the index and recall.

### Evidence Attribution
Each `PhotoRAGItem` carries an `[Evidence]` array tracing which search lane contributed: `.vector`, `.text(snippet:)`, `.region(bbox:)`, or `.timeline`.

## Concurrency Model

- `PhotoRAGOrchestrator` is an actor; all state mutations are serialized.
- `ingest(assetIDs:)` uses a throttled `TaskGroup` (default concurrency: 2) to overlap metadata loading, embedding, and OCR across assets.
- `PhotosAssetMetadata.load(assetID:)` runs on `@MainActor` (Photos API requirement); only stable IDs cross the actor boundary.

## Dependencies

- `WaxCore`, `WaxVectorSearch`
- `Foundation`, `CoreGraphics`, `ImageIO`, `UniformTypeIdentifiers`
- Platform-conditional: `Photos`, `CoreLocation`, `Vision`

## Common Pitfalls

- Never call Photos APIs inside the actor; fetch IDs on MainActor first.
- `embedder.normalize` must be `true` for Metal vector search; validated at init.
- Vision bounding boxes use bottom-left origin; `VisionOCRProvider` converts to top-left.
- `decodeThumbnail` uses `CGImageSource` with `kCGImageSourceCreateThumbnailWithTransform` for orientation correctness.


<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

*No recent activity*
</claude-mem-context>