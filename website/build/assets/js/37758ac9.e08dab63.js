"use strict";(globalThis.webpackChunkwax_docs=globalThis.webpackChunkwax_docs||[]).push([[364],{9570(e,n,t){t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>o,frontMatter:()=>a,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"text-search/text-search-engine","title":"Text Search Engine","description":"Index text, search with BM25 scoring, and manage structured knowledge \u2014 all through a single actor.","source":"@site/docs/text-search/text-search-engine.md","sourceDirName":"text-search","slug":"/text-search/text-search-engine","permalink":"/docs/text-search/text-search-engine","draft":false,"unlisted":false,"editUrl":"https://github.com/christopherkarani/Wax/tree/main/website/docs/text-search/text-search-engine.md","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"sidebar_position":1,"title":"Text Search Engine","sidebar_label":"Text Search Engine"},"sidebar":"docs","previous":{"title":"Concurrency Model","permalink":"/docs/core/concurrency-model"},"next":{"title":"Vector Search Engines","permalink":"/docs/vector-search/vector-search-engines"}}');var i=t(4848),s=t(8453);const a={sidebar_position:1,title:"Text Search Engine",sidebar_label:"Text Search Engine"},c=void 0,d={},l=[{value:"Overview",id:"overview",level:2},{value:"Creating an Engine",id:"creating-an-engine",level:2},{value:"Indexing",id:"indexing",level:2},{value:"Batching Strategy",id:"batching-strategy",level:3},{value:"Searching",id:"searching",level:2},{value:"Query Syntax",id:"query-syntax",level:3},{value:"BM25 Scoring",id:"bm25-scoring",level:3},{value:"Structured Memory",id:"structured-memory",level:2},{value:"Entity Management",id:"entity-management",level:3},{value:"Fact Assertion and Querying",id:"fact-assertion-and-querying",level:3},{value:"Persistence",id:"persistence",level:2},{value:"Schema",id:"schema",level:2}];function h(e){const n={code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"Index text, search with BM25 scoring, and manage structured knowledge \u2014 all through a single actor."}),"\n",(0,i.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"FTS5SearchEngine"})," is an actor that combines SQLite FTS5 full-text search with a complete structured memory system. It handles batching, serialization, and persistence automatically."]}),"\n",(0,i.jsx)(n.h2,{id:"creating-an-engine",children:"Creating an Engine"}),"\n",(0,i.jsx)(n.p,{children:"There are three ways to create an engine:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-swift",children:"// In-memory (fresh)\nlet engine = try await FTS5SearchEngine.inMemory()\n\n// From serialized data\nlet engine = try await FTS5SearchEngine.deserialize(from: savedData)\n\n// From a Wax store\nlet engine = try await FTS5SearchEngine.load(from: waxStore)\n"})}),"\n",(0,i.jsx)(n.h2,{id:"indexing",children:"Indexing"}),"\n",(0,i.jsx)(n.p,{children:"Index frame content individually or in batches:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-swift",children:'// Single document\ntry await engine.index(frameId: 42, text: "Meeting notes from Q4 review")\n\n// Batch (much faster \u2014 single transaction for N documents)\ntry await engine.indexBatch(\n    frameIds: [1, 2, 3],\n    texts: ["First doc", "Second doc", "Third doc"]\n)\n\n// Remove a document\ntry await engine.remove(frameId: 42)\n'})}),"\n",(0,i.jsx)(n.h3,{id:"batching-strategy",children:"Batching Strategy"}),"\n",(0,i.jsx)(n.p,{children:"The engine maintains an internal queue of pending operations. Operations are flushed to SQLite in batches:"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Queue"}),(0,i.jsx)(n.th,{children:"Threshold"}),(0,i.jsx)(n.th,{children:"Trigger"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Text index ops"}),(0,i.jsx)(n.td,{children:"2,048 documents"}),(0,i.jsx)(n.td,{children:"Auto-flush on threshold, or on search/serialize/count"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Structured memory ops"}),(0,i.jsx)(n.td,{children:"512 operations"}),(0,i.jsx)(n.td,{children:"Auto-flush on threshold"})]})]})]}),"\n",(0,i.jsx)(n.p,{children:"This amortizes transaction overhead while keeping memory usage bounded."}),"\n",(0,i.jsx)(n.h2,{id:"searching",children:"Searching"}),"\n",(0,i.jsx)(n.p,{children:"Search returns results ranked by BM25 relevance:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-swift",children:'let results = try await engine.search(query: "quarterly review", topK: 10)\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Each ",(0,i.jsx)(n.code,{children:"TextSearchResult"})," contains:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"frameId"})})," \u2014 The matching frame's identifier"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"score"})})," \u2014 BM25 relevance score (higher is better)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"snippet"})})," \u2014 Context around the match with ",(0,i.jsx)(n.code,{children:"["})," ",(0,i.jsx)(n.code,{children:"]"})," delimiters and ",(0,i.jsx)(n.code,{children:"..."})," for truncation (up to 10 terms)"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"query-syntax",children:"Query Syntax"}),"\n",(0,i.jsx)(n.p,{children:"FTS5 supports rich query operators:"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Syntax"}),(0,i.jsx)(n.th,{children:"Meaning"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"swift actors"})}),(0,i.jsx)(n.td,{children:"Match both terms (implicit AND)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"swift OR actors"})}),(0,i.jsx)(n.td,{children:"Match either term"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:'"swift actors"'})}),(0,i.jsx)(n.td,{children:"Exact phrase match"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"swift*"})}),(0,i.jsx)(n.td,{children:"Prefix match"})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"bm25-scoring",children:"BM25 Scoring"}),"\n",(0,i.jsxs)(n.p,{children:["SQLite FTS5's built-in ",(0,i.jsx)(n.code,{children:"bm25()"}),' function provides Okapi BM25 ranking. The engine inverts the raw rank (which is "lower is better") so that returned scores follow a "higher is better" convention. Scores typically range from 0 to 100+, depending on term frequency and document length.']}),"\n",(0,i.jsx)(n.h2,{id:"structured-memory",children:"Structured Memory"}),"\n",(0,i.jsx)(n.p,{children:"The engine also stores and queries an entity-fact knowledge graph. See the WaxCore module's Structured Memory article for the data model."}),"\n",(0,i.jsx)(n.h3,{id:"entity-management",children:"Entity Management"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-swift",children:'// Create or update an entity\nlet entityId = try await engine.upsertEntity(\n    key: EntityKey("alice"),\n    kind: "Person",\n    aliases: ["Alice Smith", "A. Smith"],\n    nowMs: Int64(Date().timeIntervalSince1970 * 1000)\n)\n\n// Fuzzy-match entities by alias\nlet matches = try await engine.resolveEntities(\n    matchingAlias: "alice",\n    limit: 10\n)\n'})}),"\n",(0,i.jsx)(n.h3,{id:"fact-assertion-and-querying",children:"Fact Assertion and Querying"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-swift",children:'// Assert a fact with temporal bounds\nlet factId = try await engine.assertFact(\n    subject: EntityKey("alice"),\n    predicate: PredicateKey("works_at"),\n    object: .string("Acme Corp"),\n    valid: StructuredTimeRange(fromMs: startMs, toMs: nil),\n    system: StructuredTimeRange(fromMs: nowMs, toMs: nil),\n    evidence: [evidence]\n)\n\n// Query facts\nlet result = try await engine.facts(\n    about: EntityKey("alice"),\n    predicate: nil,\n    asOf: StructuredMemoryAsOf(systemTimeMs: nowMs, validTimeMs: nowMs),\n    limit: 100\n)\n'})}),"\n",(0,i.jsx)(n.h2,{id:"persistence",children:"Persistence"}),"\n",(0,i.jsx)(n.p,{children:"The engine serializes its entire state as a SQLite database blob:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-swift",children:"// Serialize\nlet data = try await engine.serialize(compact: true)\n\n// Stage for Wax commit\ntry await engine.stageForCommit(into: waxStore, compact: false)\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"compact"})," flag runs ",(0,i.jsx)(n.code,{children:"VACUUM"})," to reclaim unused space before serialization."]}),"\n",(0,i.jsx)(n.h2,{id:"schema",children:"Schema"}),"\n",(0,i.jsx)(n.p,{children:"The engine uses the following SQLite tables:"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Table"}),(0,i.jsx)(n.th,{children:"Purpose"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"frames_fts"})}),(0,i.jsx)(n.td,{children:"FTS5 virtual table for full-text search"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"frame_mapping"})}),(0,i.jsx)(n.td,{children:"Maps frame IDs to FTS5 rowids"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"sm_entity"})}),(0,i.jsx)(n.td,{children:"Named entities with unique keys"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"sm_entity_alias"})}),(0,i.jsx)(n.td,{children:"Normalized aliases for fuzzy entity lookup"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"sm_predicate"})}),(0,i.jsx)(n.td,{children:"Relationship/property types"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"sm_fact"})}),(0,i.jsx)(n.td,{children:"RDF-like triples with bitemporal spans"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"sm_fact_span"})}),(0,i.jsx)(n.td,{children:"Temporal scopes for facts"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"sm_evidence"})}),(0,i.jsx)(n.td,{children:"Provenance links to source frames"})]})]})]}),"\n",(0,i.jsxs)(n.p,{children:["The database uses application ID ",(0,i.jsx)(n.code,{children:"0x57415854"}),' ("WAXT") and schema version 2.']})]})}function o(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},8453(e,n,t){t.d(n,{R:()=>a,x:()=>c});var r=t(6540);const i={},s=r.createContext(i);function a(e){const n=r.useContext(s);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);