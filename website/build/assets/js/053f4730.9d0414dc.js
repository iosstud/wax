"use strict";(globalThis.webpackChunkwax_docs=globalThis.webpackChunkwax_docs||[]).push([[647],{8395(e,n,s){s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>h,frontMatter:()=>d,metadata:()=>t,toc:()=>a});const t=JSON.parse('{"id":"orchestrator/rag-pipeline","title":"RAG Pipeline","description":"Understand the token-budget-aware context assembly with surrogate tiers and intent-aware reranking.","source":"@site/docs/orchestrator/rag-pipeline.md","sourceDirName":"orchestrator","slug":"/orchestrator/rag-pipeline","permalink":"/docs/orchestrator/rag-pipeline","draft":false,"unlisted":false,"editUrl":"https://github.com/christopherkarani/Wax/tree/main/website/docs/orchestrator/rag-pipeline.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2,"title":"RAG Pipeline","sidebar_label":"RAG Pipeline"},"sidebar":"docs","previous":{"title":"Memory Orchestrator","permalink":"/docs/orchestrator/memory-orchestrator"},"next":{"title":"Unified Search","permalink":"/docs/orchestrator/unified-search"}}');var r=s(4848),i=s(8453);const d={sidebar_position:2,title:"RAG Pipeline",sidebar_label:"RAG Pipeline"},c=void 0,l={},a=[{value:"Overview",id:"overview",level:2},{value:"Pipeline Stages",id:"pipeline-stages",level:2},{value:"1. Unified Search",id:"1-unified-search",level:3},{value:"2. Answer-Focused Reranking",id:"2-answer-focused-reranking",level:3},{value:"Intent Detection",id:"intent-detection",level:3},{value:"Distractor Penalties",id:"distractor-penalties",level:3},{value:"3. Token Budget Assembly",id:"3-token-budget-assembly",level:3},{value:"Expansion",id:"expansion",level:4},{value:"Surrogates (denseCached mode only)",id:"surrogates-densecached-mode-only",level:4},{value:"Snippets",id:"snippets",level:4},{value:"Configuration",id:"configuration",level:2},{value:"Surrogate Tier Selection",id:"surrogate-tier-selection",level:2},{value:"Output",id:"output",level:2}];function o(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"Understand the token-budget-aware context assembly with surrogate tiers and intent-aware reranking."}),"\n",(0,r.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"FastRAGContextBuilder"})," assembles a ",(0,r.jsx)(n.code,{children:"RAGContext"})," from search results within a configurable token budget. It uses a multi-stage pipeline: unified search, intent-aware reranking, expansion, surrogates, and snippets."]}),"\n",(0,r.jsx)(n.h2,{id:"pipeline-stages",children:"Pipeline Stages"}),"\n",(0,r.jsx)(n.h3,{id:"1-unified-search",children:"1. Unified Search"}),"\n",(0,r.jsxs)(n.p,{children:["The builder issues a ",(0,r.jsx)(n.code,{children:"SearchRequest"})," that runs across multiple search lanes simultaneously (see ",(0,r.jsx)(n.a,{href:"/docs/orchestrator/unified-search",children:"Unified Search"}),"). Results are fused using reciprocal rank fusion (RRF)."]}),"\n",(0,r.jsx)(n.h3,{id:"2-answer-focused-reranking",children:"2. Answer-Focused Reranking"}),"\n",(0,r.jsxs)(n.p,{children:["When ",(0,r.jsx)(n.code,{children:"enableAnswerFocusedRanking"})," is true (default), the top candidates are reranked within a configurable window (",(0,r.jsx)(n.code,{children:"answerRerankWindow"}),", default 12)."]}),"\n",(0,r.jsx)(n.p,{children:"Reranking factors:"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Factor"}),(0,r.jsx)(n.th,{children:"Weight"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Term recall"}),(0,r.jsx)(n.td,{children:"0.80"}),(0,r.jsx)(n.td,{children:"Fraction of query terms found in the result"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Term precision"}),(0,r.jsx)(n.td,{children:"0.40"}),(0,r.jsx)(n.td,{children:"Fraction of result terms that match the query"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Entity coverage"}),(0,r.jsx)(n.td,{children:"0.90-1.25"}),(0,r.jsx)(n.td,{children:"Named entity overlap (boosted when vector-influenced)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Year match"}),(0,r.jsx)(n.td,{children:"1.35"}),(0,r.jsx)(n.td,{children:"Results containing years mentioned in the query"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Date literal match"}),(0,r.jsx)(n.td,{children:"1.15"}),(0,r.jsx)(n.td,{children:"Results containing specific dates from the query"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"intent-detection",children:"Intent Detection"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"QueryAnalyzer"})," detects query intent patterns that influence scoring:"]}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Intent"}),(0,r.jsx)(n.th,{children:"Pattern Examples"}),(0,r.jsx)(n.th,{children:"Effect"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Location"}),(0,r.jsx)(n.td,{children:'"where", "location", "address"'}),(0,r.jsx)(n.td,{children:"Boosts results with location data"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Date"}),(0,r.jsx)(n.td,{children:'"when", "what date", "what time"'}),(0,r.jsx)(n.td,{children:"Boosts results with temporal content"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Ownership"}),(0,r.jsx)(n.td,{children:'"whose", "who owns", "belong to"'}),(0,r.jsx)(n.td,{children:"Boosts results with ownership assertions"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Multi-hop"}),(0,r.jsx)(n.td,{children:"Multiple entity references"}),(0,r.jsx)(n.td,{children:"Enables broader search"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"distractor-penalties",children:"Distractor Penalties"}),"\n",(0,r.jsxs)(n.p,{children:["Results matching distractor patterns receive a configurable penalty (",(0,r.jsx)(n.code,{children:"answerDistractorPenalty"}),", default 0.70):"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:'Tentative language ("tentative", "no authoritative")'}),"\n",(0,r.jsx)(n.li,{children:'Checklists and reports ("weekly report", "checklist", "signoff")'}),"\n",(0,r.jsx)(n.li,{children:'Draft content ("draft memo", "placeholder")'}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"3-token-budget-assembly",children:"3. Token Budget Assembly"}),"\n",(0,r.jsx)(n.p,{children:"The builder allocates the total token budget across three tiers:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  maxContextTokens (default 1500)\u2502\n\u2502                                 \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502 Expansion (up to 600 tok) \u2502  \u2502  First result, expanded\n\u2502  \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524  \u2502\n\u2502  \u2502 Surrogates (60 tok each)  \u2502  \u2502  Tier-selected summaries\n\u2502  \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524  \u2502\n\u2502  \u2502 Snippets (200 tok each)   \u2502  \u2502  Remaining results\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,r.jsx)(n.h4,{id:"expansion",children:"Expansion"}),"\n",(0,r.jsxs)(n.p,{children:["The top-ranked result is expanded to its full frame content, capped at ",(0,r.jsx)(n.code,{children:"expansionMaxTokens"})," (default 600) and ",(0,r.jsx)(n.code,{children:"expansionMaxBytes"}),"."]}),"\n",(0,r.jsx)(n.h4,{id:"surrogates-densecached-mode-only",children:"Surrogates (denseCached mode only)"}),"\n",(0,r.jsxs)(n.p,{children:["In ",(0,r.jsx)(n.code,{children:"denseCached"})," mode, additional context is added as tier-selected surrogates. Each surrogate is a compressed representation of a frame, selected by age or importance:"]}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Tier"}),(0,r.jsx)(n.th,{children:"Content"}),(0,r.jsx)(n.th,{children:"Max Tokens"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"full"})}),(0,r.jsx)(n.td,{children:"Complete frame text"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"surrogateMaxTokens"})," (60)"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"gist"})}),(0,r.jsx)(n.td,{children:"Summary/gist"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"surrogateMaxTokens"})," (60)"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"micro"})}),(0,r.jsx)(n.td,{children:"Key phrases only"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"surrogateMaxTokens"})," (60)"]})]})]})]}),"\n",(0,r.jsx)(n.h4,{id:"snippets",children:"Snippets"}),"\n",(0,r.jsxs)(n.p,{children:["Remaining budget is filled with preview-based snippets from additional search results, each capped at ",(0,r.jsx)(n.code,{children:"snippetMaxTokens"})," (200)."]}),"\n",(0,r.jsx)(n.p,{children:"For certain query intents (location, date, ownership), snippets may be expanded to their full frame content if the preview appears to contain the answer."}),"\n",(0,r.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"FastRAGConfig"})," controls all pipeline parameters:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-swift",children:"var config = FastRAGConfig()\n\n// Mode\nconfig.mode = .fast  // .fast or .denseCached\n\n// Token budgets\nconfig.maxContextTokens = 2000\nconfig.expansionMaxTokens = 800\nconfig.snippetMaxTokens = 300\nconfig.surrogateMaxTokens = 80\nconfig.maxSnippets = 5\nconfig.maxSurrogates = 10\n\n// Search\nconfig.searchTopK = 32\nconfig.searchMode = .hybrid(alpha: 0.5)\nconfig.rrfK = 60\n\n// Reranking\nconfig.enableAnswerFocusedRanking = true\nconfig.answerRerankWindow = 12\nconfig.answerDistractorPenalty = 0.70\n"})}),"\n",(0,r.jsx)(n.h2,{id:"surrogate-tier-selection",children:"Surrogate Tier Selection"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"SurrogateTierSelector"})," chooses which tier to use for each surrogate based on configurable policies:"]}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Policy"}),(0,r.jsx)(n.th,{children:"Strategy"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:".disabled"})}),(0,r.jsxs)(n.td,{children:["Always use ",(0,r.jsx)(n.code,{children:"full"})," tier"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:".ageOnly(thresholds)"})}),(0,r.jsx)(n.td,{children:"Recent (< 7 days) = full, old (< 30 days) = gist, older = micro"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:".importance(thresholds)"})}),(0,r.jsx)(n.td,{children:"Based on access frequency: > 0.6 = full, > 0.3 = gist, else micro"})]})]})]}),"\n",(0,r.jsxs)(n.p,{children:["When ",(0,r.jsx)(n.code,{children:"enableQueryAwareTierSelection"})," is true, the tier can be boosted based on query specificity (quoted phrases, named entities)."]}),"\n",(0,r.jsx)(n.h2,{id:"output",children:"Output"}),"\n",(0,r.jsxs)(n.p,{children:["The pipeline returns a ",(0,r.jsx)(n.code,{children:"RAGContext"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-swift",children:"public struct RAGContext {\n    public let query: String\n    public let items: [Item]\n    public let totalTokens: Int\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Each item has a ",(0,r.jsx)(n.code,{children:"kind"})," (",(0,r.jsx)(n.code,{children:".snippet"}),", ",(0,r.jsx)(n.code,{children:".expanded"}),", or ",(0,r.jsx)(n.code,{children:".surrogate"}),"), the source ",(0,r.jsx)(n.code,{children:"frameId"}),", a relevance ",(0,r.jsx)(n.code,{children:"score"}),", and the assembled ",(0,r.jsx)(n.code,{children:"text"}),"."]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}},8453(e,n,s){s.d(n,{R:()=>d,x:()=>c});var t=s(6540);const r={},i=t.createContext(r);function d(e){const n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:d(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);