"use strict";(globalThis.webpackChunkwax_docs=globalThis.webpackChunkwax_docs||[]).push([[660],{6263(e,s,r){r.r(s),r.d(s,{assets:()=>l,contentTitle:()=>c,default:()=>a,frontMatter:()=>t,metadata:()=>n,toc:()=>h});const n=JSON.parse('{"id":"core/file-format","title":"MV2S File Format","description":"Understand the binary layout of .mv2s files: dual headers, WAL ring buffer, TOC, and footer.","source":"@site/docs/core/file-format.md","sourceDirName":"core","slug":"/core/file-format","permalink":"/docs/core/file-format","draft":false,"unlisted":false,"editUrl":"https://github.com/christopherkarani/Wax/tree/main/website/docs/core/file-format.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2,"title":"MV2S File Format","sidebar_label":"File Format"},"sidebar":"docs","previous":{"title":"Getting Started","permalink":"/docs/core/getting-started"},"next":{"title":"WAL & Crash Recovery","permalink":"/docs/core/wal-crash-recovery"}}');var d=r(4848),i=r(8453);const t={sidebar_position:2,title:"MV2S File Format",sidebar_label:"File Format"},c=void 0,l={},h=[{value:"Overview",id:"overview",level:2},{value:"Magic Numbers",id:"magic-numbers",level:2},{value:"Dual Header Pages",id:"dual-header-pages",level:2},{value:"A/B Selection Strategy",id:"ab-selection-strategy",level:3},{value:"WAL Ring Buffer",id:"wal-ring-buffer",level:2},{value:"Table of Contents (TOC)",id:"table-of-contents-toc",level:2},{value:"Footer",id:"footer",level:2},{value:"Frame Metadata",id:"frame-metadata",level:2},{value:"Compression",id:"compression",level:2},{value:"Constants and Limits",id:"constants-and-limits",level:2}];function o(e){const s={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsxs)(s.p,{children:["Understand the binary layout of ",(0,d.jsx)(s.code,{children:".mv2s"})," files: dual headers, WAL ring buffer, TOC, and footer."]}),"\n",(0,d.jsx)(s.h2,{id:"overview",children:"Overview"}),"\n",(0,d.jsxs)(s.p,{children:["The MV2S (Memory V2 Store) format is a self-contained binary file designed for crash-safe, concurrent access. Every ",(0,d.jsx)(s.code,{children:".mv2s"})," file follows this layout:"]}),"\n",(0,d.jsx)(s.pre,{children:(0,d.jsx)(s.code,{children:"Offset          Region              Size\n\u2500\u2500\u2500\u2500\u2500\u2500          \u2500\u2500\u2500\u2500\u2500\u2500              \u2500\u2500\u2500\u2500\n0 KiB           Header Page A       4 KiB\n4 KiB           Header Page B       4 KiB\n8 KiB           WAL Ring Buffer     Configurable (default 256 MiB)\nWAL + 8 KiB     Frame Payloads      Variable\nAfter Payloads  TOC                 Variable\nAfter TOC       Footer              64 bytes\n"})}),"\n",(0,d.jsx)(s.h2,{id:"magic-numbers",children:"Magic Numbers"}),"\n",(0,d.jsx)(s.p,{children:"The format uses two magic values for identification:"}),"\n",(0,d.jsxs)(s.table,{children:[(0,d.jsx)(s.thead,{children:(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.th,{children:"Magic"}),(0,d.jsx)(s.th,{children:"Bytes"}),(0,d.jsx)(s.th,{children:"Location"})]})}),(0,d.jsxs)(s.tbody,{children:[(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"MV2S"})}),(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"0x4D 0x56 0x32 0x5B"})}),(0,d.jsx)(s.td,{children:"Header page offset 0"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"MV2SFOOT"})}),(0,d.jsx)(s.td,{children:"8 bytes"}),(0,d.jsx)(s.td,{children:"Footer offset 0"})]})]})]}),"\n",(0,d.jsxs)(s.p,{children:["The current spec version is ",(0,d.jsx)(s.strong,{children:"v1.0"})," (major=1, minor=0, packed as UInt16)."]}),"\n",(0,d.jsx)(s.h2,{id:"dual-header-pages",children:"Dual Header Pages"}),"\n",(0,d.jsx)(s.p,{children:"Two identical header pages at offsets 0 and 4 KiB provide crash-safe metadata updates. Each page contains:"}),"\n",(0,d.jsxs)(s.table,{children:[(0,d.jsx)(s.thead,{children:(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.th,{children:"Offset"}),(0,d.jsx)(s.th,{children:"Type"}),(0,d.jsx)(s.th,{children:"Field"})]})}),(0,d.jsxs)(s.tbody,{children:[(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"0\u20133"}),(0,d.jsx)(s.td,{children:"UInt32"}),(0,d.jsxs)(s.td,{children:["Magic (",(0,d.jsx)(s.code,{children:"MV2S"}),")"]})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"4\u20135"}),(0,d.jsx)(s.td,{children:"UInt16"}),(0,d.jsx)(s.td,{children:"Format version"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"6\u20137"}),(0,d.jsx)(s.td,{children:"UInt8 x 2"}),(0,d.jsx)(s.td,{children:"Spec major/minor"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"8\u201315"}),(0,d.jsx)(s.td,{children:"UInt64"}),(0,d.jsx)(s.td,{children:"Header page generation"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"16\u201323"}),(0,d.jsx)(s.td,{children:"UInt64"}),(0,d.jsx)(s.td,{children:"File generation"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"24\u201331"}),(0,d.jsx)(s.td,{children:"UInt64"}),(0,d.jsx)(s.td,{children:"Footer offset"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"32\u201339"}),(0,d.jsx)(s.td,{children:"UInt64"}),(0,d.jsx)(s.td,{children:"WAL offset"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"40\u201347"}),(0,d.jsx)(s.td,{children:"UInt64"}),(0,d.jsx)(s.td,{children:"WAL size"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"48\u201355"}),(0,d.jsx)(s.td,{children:"UInt64"}),(0,d.jsx)(s.td,{children:"WAL write position"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"56\u201363"}),(0,d.jsx)(s.td,{children:"UInt64"}),(0,d.jsx)(s.td,{children:"WAL checkpoint position"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"64\u201371"}),(0,d.jsx)(s.td,{children:"UInt64"}),(0,d.jsx)(s.td,{children:"WAL committed sequence"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"72\u2013103"}),(0,d.jsx)(s.td,{children:"32 bytes"}),(0,d.jsx)(s.td,{children:"TOC checksum (SHA-256)"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"104\u2013135"}),(0,d.jsx)(s.td,{children:"32 bytes"}),(0,d.jsx)(s.td,{children:"Header checksum (SHA-256)"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"136\u2013208"}),(0,d.jsx)(s.td,{children:"72 bytes"}),(0,d.jsx)(s.td,{children:"WAL replay snapshot (optional)"})]})]})]}),"\n",(0,d.jsx)(s.h3,{id:"ab-selection-strategy",children:"A/B Selection Strategy"}),"\n",(0,d.jsxs)(s.p,{children:["On open, both header pages are read and validated. The page with the ",(0,d.jsxs)(s.strong,{children:["highest ",(0,d.jsx)(s.code,{children:"headerPageGeneration"})]})," is selected, provided it has a valid magic number, supported format version, and correct checksum."]}),"\n",(0,d.jsx)(s.p,{children:"This ensures that a crash during a header write never corrupts the store \u2014 at worst, the previous header generation is used."}),"\n",(0,d.jsx)(s.h2,{id:"wal-ring-buffer",children:"WAL Ring Buffer"}),"\n",(0,d.jsxs)(s.p,{children:["The WAL occupies a fixed-size region starting at offset 8 KiB. See ",(0,d.jsx)(s.a,{href:"/docs/core/wal-crash-recovery",children:"WAL & Crash Recovery"})," for details on the ring buffer protocol, record format, and replay semantics."]}),"\n",(0,d.jsx)(s.h2,{id:"table-of-contents-toc",children:"Table of Contents (TOC)"}),"\n",(0,d.jsxs)(s.p,{children:["The TOC is a binary-encoded structure (via ",(0,d.jsx)(s.code,{children:"BinaryEncoder"}),") containing:"]}),"\n",(0,d.jsxs)(s.ul,{children:["\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:(0,d.jsx)(s.code,{children:"tocVersion"})})," (UInt64) \u2014 Currently version 1"]}),"\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:(0,d.jsx)(s.code,{children:"frames"})})," \u2014 Dense array of ",(0,d.jsx)(s.code,{children:"FrameMeta"})," entries (frame IDs are sequential array indices)"]}),"\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:(0,d.jsx)(s.code,{children:"indexes"})})," \u2014 Index manifests for lexical and vector search segments"]}),"\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:(0,d.jsx)(s.code,{children:"timeIndex"})})," \u2014 Optional temporal index manifest"]}),"\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:(0,d.jsx)(s.code,{children:"segmentCatalog"})})," \u2014 Content segment catalog"]}),"\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:(0,d.jsx)(s.code,{children:"merkleRoot"})})," \u2014 32-byte Merkle root for integrity verification"]}),"\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:(0,d.jsx)(s.code,{children:"tocChecksum"})})," \u2014 SHA-256 of the TOC body (excluding the final 32 checksum bytes, padded with 32 zero bytes)"]}),"\n"]}),"\n",(0,d.jsx)(s.h2,{id:"footer",children:"Footer"}),"\n",(0,d.jsx)(s.p,{children:"A fixed 64-byte footer at the end of the file:"}),"\n",(0,d.jsxs)(s.table,{children:[(0,d.jsx)(s.thead,{children:(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.th,{children:"Offset"}),(0,d.jsx)(s.th,{children:"Type"}),(0,d.jsx)(s.th,{children:"Field"})]})}),(0,d.jsxs)(s.tbody,{children:[(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"0\u20137"}),(0,d.jsx)(s.td,{children:"8 bytes"}),(0,d.jsxs)(s.td,{children:["Magic (",(0,d.jsx)(s.code,{children:"MV2SFOOT"}),")"]})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"8\u201315"}),(0,d.jsx)(s.td,{children:"UInt64"}),(0,d.jsx)(s.td,{children:"TOC length"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"16\u201347"}),(0,d.jsx)(s.td,{children:"32 bytes"}),(0,d.jsx)(s.td,{children:"TOC hash (SHA-256)"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"48\u201355"}),(0,d.jsx)(s.td,{children:"UInt64"}),(0,d.jsx)(s.td,{children:"Generation"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"56\u201363"}),(0,d.jsx)(s.td,{children:"UInt64"}),(0,d.jsx)(s.td,{children:"WAL committed sequence"})]})]})]}),"\n",(0,d.jsx)(s.p,{children:"The footer's TOC hash must match the TOC's self-checksum for the file to be considered valid."}),"\n",(0,d.jsx)(s.h2,{id:"frame-metadata",children:"Frame Metadata"}),"\n",(0,d.jsxs)(s.p,{children:["Each frame stored in the TOC carries rich metadata via ",(0,d.jsx)(s.code,{children:"FrameMeta"}),":"]}),"\n",(0,d.jsxs)(s.ul,{children:["\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:"Identity"}),": ",(0,d.jsx)(s.code,{children:"id"}),", ",(0,d.jsx)(s.code,{children:"timestamp"}),", ",(0,d.jsx)(s.code,{children:"anchorTs"}),", ",(0,d.jsx)(s.code,{children:"uri"}),", ",(0,d.jsx)(s.code,{children:"title"})]}),"\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:"Content"}),": ",(0,d.jsx)(s.code,{children:"payloadOffset"}),", ",(0,d.jsx)(s.code,{children:"payloadLength"}),", ",(0,d.jsx)(s.code,{children:"canonicalEncoding"}),", ",(0,d.jsx)(s.code,{children:"canonicalLength"})]}),"\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:"Integrity"}),": ",(0,d.jsx)(s.code,{children:"checksum"})," (SHA-256 of canonical form), ",(0,d.jsx)(s.code,{children:"storedChecksum"})]}),"\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:"Organization"}),": ",(0,d.jsx)(s.code,{children:"kind"}),", ",(0,d.jsx)(s.code,{children:"track"}),", ",(0,d.jsx)(s.code,{children:"tags"}),", ",(0,d.jsx)(s.code,{children:"labels"}),", ",(0,d.jsx)(s.code,{children:"metadata"})," (string-to-string map)"]}),"\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:"Search"}),": ",(0,d.jsx)(s.code,{children:"searchText"}),", ",(0,d.jsx)(s.code,{children:"contentDates"})]}),"\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:"Relationships"}),": ",(0,d.jsx)(s.code,{children:"role"})," (document/chunk/blob/system), ",(0,d.jsx)(s.code,{children:"parentId"}),", ",(0,d.jsx)(s.code,{children:"supersedes"}),", ",(0,d.jsx)(s.code,{children:"supersededBy"})]}),"\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:"Chunking"}),": ",(0,d.jsx)(s.code,{children:"chunkIndex"}),", ",(0,d.jsx)(s.code,{children:"chunkCount"}),", ",(0,d.jsx)(s.code,{children:"chunkManifest"})]}),"\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:"Status"}),": ",(0,d.jsx)(s.code,{children:"active"})," or ",(0,d.jsx)(s.code,{children:"deleted"})]}),"\n"]}),"\n",(0,d.jsx)(s.h2,{id:"compression",children:"Compression"}),"\n",(0,d.jsxs)(s.p,{children:["Frame payloads support four encoding strategies via ",(0,d.jsx)(s.code,{children:"CanonicalEncoding"}),":"]}),"\n",(0,d.jsxs)(s.table,{children:[(0,d.jsx)(s.thead,{children:(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.th,{children:"Encoding"}),(0,d.jsx)(s.th,{children:"Description"})]})}),(0,d.jsxs)(s.tbody,{children:[(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"plain"})}),(0,d.jsx)(s.td,{children:"No compression"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"lzfse"})}),(0,d.jsx)(s.td,{children:"Apple's LZFSE (best ratio on Apple platforms)"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"lz4"})}),(0,d.jsx)(s.td,{children:"Fast compression/decompression"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"deflate"})}),(0,d.jsx)(s.td,{children:"Widely compatible zlib deflate"})]})]})]}),"\n",(0,d.jsx)(s.h2,{id:"constants-and-limits",children:"Constants and Limits"}),"\n",(0,d.jsxs)(s.table,{children:[(0,d.jsx)(s.thead,{children:(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.th,{children:"Constant"}),(0,d.jsx)(s.th,{children:"Value"})]})}),(0,d.jsxs)(s.tbody,{children:[(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"Header page size"}),(0,d.jsx)(s.td,{children:"4 KiB"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"Header region (A+B)"}),(0,d.jsx)(s.td,{children:"8 KiB"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"Footer size"}),(0,d.jsx)(s.td,{children:"64 bytes"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"WAL record header"}),(0,d.jsx)(s.td,{children:"48 bytes"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"Default WAL size"}),(0,d.jsx)(s.td,{children:"256 MiB"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"Max string bytes"}),(0,d.jsx)(s.td,{children:"16 MiB"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"Max blob bytes"}),(0,d.jsx)(s.td,{children:"256 MiB"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"Max array count"}),(0,d.jsx)(s.td,{children:"10,000,000"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"Max TOC bytes"}),(0,d.jsx)(s.td,{children:"64 MiB"})]})]})]})]})}function a(e={}){const{wrapper:s}={...(0,i.R)(),...e.components};return s?(0,d.jsx)(s,{...e,children:(0,d.jsx)(o,{...e})}):o(e)}},8453(e,s,r){r.d(s,{R:()=>t,x:()=>c});var n=r(6540);const d={},i=n.createContext(d);function t(e){const s=n.useContext(i);return n.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(d):e.components||d:t(e.components),n.createElement(i.Provider,{value:s},e.children)}}}]);