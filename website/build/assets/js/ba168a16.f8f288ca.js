"use strict";(globalThis.webpackChunkwax_docs=globalThis.webpackChunkwax_docs||[]).push([[669],{5408(e,r,n){n.r(r),n.d(r,{assets:()=>c,contentTitle:()=>a,default:()=>o,frontMatter:()=>l,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"orchestrator/unified-search","title":"Unified Search","description":"Fuse BM25, vector, structured memory, and timeline results with reciprocal rank fusion.","source":"@site/docs/orchestrator/unified-search.md","sourceDirName":"orchestrator","slug":"/orchestrator/unified-search","permalink":"/docs/orchestrator/unified-search","draft":false,"unlisted":false,"editUrl":"https://github.com/christopherkarani/Wax/tree/main/website/docs/orchestrator/unified-search.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3,"title":"Unified Search","sidebar_label":"Unified Search"},"sidebar":"docs","previous":{"title":"RAG Pipeline","permalink":"/docs/orchestrator/rag-pipeline"},"next":{"title":"Session Management","permalink":"/docs/orchestrator/session-management"}}');var i=n(4848),t=n(8453);const l={sidebar_position:3,title:"Unified Search",sidebar_label:"Unified Search"},a=void 0,c={},d=[{value:"Overview",id:"overview",level:2},{value:"Search Lanes",id:"search-lanes",level:2},{value:"Text Lane",id:"text-lane",level:3},{value:"Vector Lane",id:"vector-lane",level:3},{value:"Structured Memory Lane",id:"structured-memory-lane",level:3},{value:"Timeline Lane",id:"timeline-lane",level:3},{value:"Reciprocal Rank Fusion (RRF)",id:"reciprocal-rank-fusion-rrf",level:2},{value:"Query Classification",id:"query-classification",level:2},{value:"Search Request",id:"search-request",level:2},{value:"Search Modes",id:"search-modes",level:3},{value:"Frame Filtering",id:"frame-filtering",level:3},{value:"Structured Memory Options",id:"structured-memory-options",level:3},{value:"Search Response",id:"search-response",level:2},{value:"Ranking Diagnostics",id:"ranking-diagnostics",level:3}];function h(e){const r={code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.p,{children:"Fuse BM25, vector, structured memory, and timeline results with reciprocal rank fusion."}),"\n",(0,i.jsx)(r.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsx)(r.p,{children:"Wax's unified search runs multiple search strategies in parallel and fuses their results using reciprocal rank fusion (RRF). This hybrid approach combines the precision of keyword search with the recall of semantic search."}),"\n",(0,i.jsx)(r.h2,{id:"search-lanes",children:"Search Lanes"}),"\n",(0,i.jsx)(r.p,{children:"Each search request can activate up to four lanes:"}),"\n",(0,i.jsxs)(r.table,{children:[(0,i.jsx)(r.thead,{children:(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.th,{children:"Lane"}),(0,i.jsx)(r.th,{children:"Engine"}),(0,i.jsx)(r.th,{children:"Best For"})]})}),(0,i.jsxs)(r.tbody,{children:[(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.strong,{children:"Text (BM25)"})}),(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"FTS5SearchEngine"})}),(0,i.jsx)(r.td,{children:"Exact keyword matches, names, codes"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.strong,{children:"Vector"})}),(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"VectorSearchEngine"})}),(0,i.jsx)(r.td,{children:"Semantic similarity, paraphrased queries"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.strong,{children:"Structured Memory"})}),(0,i.jsx)(r.td,{children:"Entity/fact queries"}),(0,i.jsx)(r.td,{children:"Known entities and relationships"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.strong,{children:"Timeline"})}),(0,i.jsx)(r.td,{children:"Reverse chronological"}),(0,i.jsx)(r.td,{children:'"Recent" and "latest" queries'})]})]})]}),"\n",(0,i.jsx)(r.h3,{id:"text-lane",children:"Text Lane"}),"\n",(0,i.jsx)(r.p,{children:"Runs an FTS5 MATCH query with BM25 scoring. If the primary query returns insufficient results, a fallback OR-expanded query broadens the search."}),"\n",(0,i.jsx)(r.h3,{id:"vector-lane",children:"Vector Lane"}),"\n",(0,i.jsxs)(r.p,{children:["Computes the cosine similarity between the query embedding and all indexed frame embeddings. Requires an ",(0,i.jsx)(r.code,{children:"EmbeddingProvider"})," to be configured."]}),"\n",(0,i.jsx)(r.h3,{id:"structured-memory-lane",children:"Structured Memory Lane"}),"\n",(0,i.jsx)(r.p,{children:"Resolves entity mentions in the query, finds related facts, and retrieves evidence frames. This lane surfaces frames that are semantically connected through the knowledge graph."}),"\n",(0,i.jsx)(r.h3,{id:"timeline-lane",children:"Timeline Lane"}),"\n",(0,i.jsx)(r.p,{children:'A reverse-chronological fallback activated for queries that imply recency (e.g., "what happened recently?"). This ensures temporal queries return results even when keyword/vector matches are sparse.'}),"\n",(0,i.jsx)(r.h2,{id:"reciprocal-rank-fusion-rrf",children:"Reciprocal Rank Fusion (RRF)"}),"\n",(0,i.jsx)(r.p,{children:"Results from all active lanes are merged using RRF:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:"score(d) = \u03a3 (weight_lane / (rrfK + rank_lane(d)))\n"})}),"\n",(0,i.jsx)(r.p,{children:"Where:"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"rrfK"})," is a smoothing constant (default 60)"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"weight_lane"})," is the per-lane weight from the adaptive fusion config"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"rank_lane(d)"})," is the document's rank in that lane (1-based)"]}),"\n"]}),"\n",(0,i.jsx)(r.p,{children:"RRF is robust to score scale differences between lanes and naturally handles documents that appear in multiple lanes."}),"\n",(0,i.jsx)(r.h2,{id:"query-classification",children:"Query Classification"}),"\n",(0,i.jsxs)(r.p,{children:["The ",(0,i.jsx)(r.code,{children:"RuleBasedQueryClassifier"})," categorizes queries to adjust fusion weights:"]}),"\n",(0,i.jsxs)(r.table,{children:[(0,i.jsx)(r.thead,{children:(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.th,{children:"Type"}),(0,i.jsx)(r.th,{children:"Triggers"}),(0,i.jsx)(r.th,{children:"Weight Adjustment"})]})}),(0,i.jsxs)(r.tbody,{children:[(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"Factual"}),(0,i.jsx)(r.td,{children:'"what is", "who is", "define"'}),(0,i.jsx)(r.td,{children:"Higher BM25 weight"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"Semantic"}),(0,i.jsx)(r.td,{children:'"how", "why", "explain"'}),(0,i.jsx)(r.td,{children:"Higher vector weight"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"Temporal"}),(0,i.jsx)(r.td,{children:'"when", "recent", "yesterday"'}),(0,i.jsx)(r.td,{children:"Include timeline lane"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"Exploratory"}),(0,i.jsx)(r.td,{children:"Default"}),(0,i.jsx)(r.td,{children:"Balanced weights"})]})]})]}),"\n",(0,i.jsx)(r.p,{children:"Classification is fully offline -- no ML models or network calls required."}),"\n",(0,i.jsx)(r.h2,{id:"search-request",children:"Search Request"}),"\n",(0,i.jsxs)(r.p,{children:["Configure searches with ",(0,i.jsx)(r.code,{children:"SearchRequest"}),":"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-swift",children:'let request = SearchRequest(\n    query: "quarterly roadmap",\n    embedding: queryEmbedding,     // Optional\n    mode: .hybrid(alpha: 0.5),     // 0 = vector only, 1 = text only\n    topK: 20,\n    rrfK: 60\n)\n\nlet response = try await session.search(request)\n'})}),"\n",(0,i.jsx)(r.h3,{id:"search-modes",children:"Search Modes"}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.code,{children:"SearchMode"})," controls which lanes are active:"]}),"\n",(0,i.jsxs)(r.table,{children:[(0,i.jsx)(r.thead,{children:(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.th,{children:"Mode"}),(0,i.jsx)(r.th,{children:"Active Lanes"})]})}),(0,i.jsxs)(r.tbody,{children:[(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:".textOnly"})}),(0,i.jsx)(r.td,{children:"BM25 only"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:".vectorOnly"})}),(0,i.jsx)(r.td,{children:"Vector only"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:".hybrid(alpha: Float)"})}),(0,i.jsx)(r.td,{children:"Both BM25 and vector, blended by alpha"})]})]})]}),"\n",(0,i.jsx)(r.h3,{id:"frame-filtering",children:"Frame Filtering"}),"\n",(0,i.jsx)(r.p,{children:"Restrict results with metadata predicates:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-swift",children:'var filter = FrameFilter()\nfilter.requiredTags = ["meetings"]\nfilter.requiredLabels = ["important"]\nfilter.timeRange = TimeRange(after: lastWeekMs, before: nowMs)\nfilter.includeDeleted = false\nfilter.includeSuperseded = false\n\nlet request = SearchRequest(\n    query: "standup notes",\n    frameFilter: filter\n)\n'})}),"\n",(0,i.jsx)(r.h3,{id:"structured-memory-options",children:"Structured Memory Options"}),"\n",(0,i.jsx)(r.p,{children:"Fine-tune the structured memory lane:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-swift",children:"var smOptions = StructuredMemorySearchOptions()\nsmOptions.weight = 1.0\nsmOptions.maxEntityCandidates = 5\nsmOptions.maxFacts = 20\nsmOptions.maxEvidenceFrames = 10\nsmOptions.requireEvidenceSpan = false\n"})}),"\n",(0,i.jsx)(r.h2,{id:"search-response",children:"Search Response"}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.code,{children:"SearchResponse"})," contains ranked results with source attribution:"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-swift",children:'for result in response.results {\n    print("Frame \\(result.frameId): \\(result.score)")\n    print("Sources: \\(result.sources)")  // [.text, .vector, ...]\n    print("Preview: \\(result.previewText ?? "")")\n}\n'})}),"\n",(0,i.jsxs)(r.p,{children:["Each result reports which lanes contributed via the ",(0,i.jsx)(r.code,{children:"sources"})," array:"]}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:".text"})," -- Matched in BM25 lane"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:".vector"})," -- Matched in vector lane"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:".timeline"})," -- From timeline fallback"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:".structuredMemory"})," -- Surfaced via knowledge graph"]}),"\n"]}),"\n",(0,i.jsx)(r.h3,{id:"ranking-diagnostics",children:"Ranking Diagnostics"}),"\n",(0,i.jsx)(r.p,{children:"Enable diagnostics for debugging:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-swift",children:'var request = SearchRequest(query: "test")\nrequest.enableRankingDiagnostics = true\nrequest.rankingDiagnosticsTopK = 5\n\nlet response = try await session.search(request)\nfor result in response.results {\n    if let diag = result.rankingDiagnostics {\n        print("Best lane rank: \\(diag.bestLaneRank)")\n        print("Contributions: \\(diag.laneContributions)")\n    }\n}\n'})})]})}function o(e={}){const{wrapper:r}={...(0,t.R)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},8453(e,r,n){n.d(r,{R:()=>l,x:()=>a});var s=n(6540);const i={},t=s.createContext(i);function l(e){const r=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),s.createElement(t.Provider,{value:r},e.children)}}}]);