"use strict";(globalThis.webpackChunkwax_docs=globalThis.webpackChunkwax_docs||[]).push([[443],{936(e,n,r){r.r(n),r.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>d,metadata:()=>t,toc:()=>o});const t=JSON.parse('{"id":"architecture","title":"Architecture","description":"Understand the module dependency graph, actor model, and end-to-end data flow.","source":"@site/docs/architecture.md","sourceDirName":".","slug":"/architecture","permalink":"/docs/architecture","draft":false,"unlisted":false,"editUrl":"https://github.com/christopherkarani/Wax/tree/main/website/docs/architecture.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2,"title":"Architecture","sidebar_label":"Architecture"},"sidebar":"docs","previous":{"title":"Getting Started","permalink":"/docs/intro"},"next":{"title":"Memory Orchestrator","permalink":"/docs/orchestrator/memory-orchestrator"}}');var i=r(4848),s=r(8453);const d={sidebar_position:2,title:"Architecture",sidebar_label:"Architecture"},c=void 0,a={},o=[{value:"Overview",id:"overview",level:2},{value:"Module Dependency Graph",id:"module-dependency-graph",level:2},{value:"Actor Model",id:"actor-model",level:2},{value:"Actor Boundaries",id:"actor-boundaries",level:3},{value:"End-to-End Data Flow",id:"end-to-end-data-flow",level:2},{value:"Ingestion (remember)",id:"ingestion-remember",level:3},{value:"Retrieval (recall)",id:"retrieval-recall",level:3},{value:"Read/Write Multiplexing",id:"readwrite-multiplexing",level:2},{value:"Persistence Model",id:"persistence-model",level:2}];function l(e){const n={code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"Understand the module dependency graph, actor model, and end-to-end data flow."}),"\n",(0,i.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsx)(n.p,{children:"Wax is organized as a stack of Swift Package Manager library targets. Each layer adds capability while depending only on the layers below it."}),"\n",(0,i.jsx)(n.h2,{id:"module-dependency-graph",children:"Module Dependency Graph"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                 Wax                     \u2502  Orchestration, RAG, Unified Search\n\u2502  MemoryOrchestrator, PhotoRAG, VideoRAG \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518\n             \u2502          \u2502            \u2502\n     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n     \u2502WaxText   \u2502  \u2502WaxVector    \u2502  \u2502\n     \u2502Search    \u2502  \u2502Search       \u2502  \u2502\n     \u2502(FTS5/SQL)\u2502  \u2502(USearch/    \u2502  \u2502\n     \u2502          \u2502  \u2502 Metal)      \u2502  \u2502\n     \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n          \u2502               \u2502         \u2502\n          \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n          \u2502  \u2502WaxVectorSearch    \u2502  \u2502  (trait-gated)\n          \u2502  \u2502MiniLM             \u2502  \u2502\n          \u2502  \u2502(CoreML embedder)  \u2502  \u2502\n          \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n          \u2502                         \u2502\n     \u250c\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2510\n     \u2502             WaxCore               \u2502  Persistence, WAL, Binary Codec,\n     \u2502  Wax actor, .mv2s format, Locks   \u2502  Structured Memory types\n     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,i.jsx)(n.h2,{id:"actor-model",children:"Actor Model"}),"\n",(0,i.jsx)(n.p,{children:"Every major subsystem is an actor with its own serial executor:"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Actor"}),(0,i.jsx)(n.th,{children:"Responsibility"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"MemoryOrchestrator"})}),(0,i.jsx)(n.td,{children:"Text ingestion, recall, session management"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"PhotoRAGOrchestrator"})}),(0,i.jsx)(n.td,{children:"Photo library sync, OCR, photo queries"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"VideoRAGOrchestrator"})}),(0,i.jsx)(n.td,{children:"Video ingestion, transcript handling, segment queries"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"WaxSession"})}),(0,i.jsx)(n.td,{children:"Frame writes, search delegation, structured memory"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"Wax"})," (WaxCore)"]}),(0,i.jsx)(n.td,{children:"File I/O, WAL, frame storage, writer leasing"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"FTS5SearchEngine"})}),(0,i.jsx)(n.td,{children:"BM25 indexing/search, structured memory persistence"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"USearchVectorEngine"})}),(0,i.jsx)(n.td,{children:"CPU vector index"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"MetalVectorEngine"})}),(0,i.jsx)(n.td,{children:"GPU vector index"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"MiniLMEmbedder"})}),(0,i.jsx)(n.td,{children:"CoreML inference"})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"actor-boundaries",children:"Actor Boundaries"}),"\n",(0,i.jsxs)(n.p,{children:["Each actor maintains its own mutable state. Communication between actors happens exclusively through ",(0,i.jsx)(n.code,{children:"async"})," method calls, with ",(0,i.jsx)(n.code,{children:"Sendable"})," types crossing boundaries."]}),"\n",(0,i.jsx)(n.h2,{id:"end-to-end-data-flow",children:"End-to-End Data Flow"}),"\n",(0,i.jsx)(n.h3,{id:"ingestion-remember",children:"Ingestion (remember)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"User text\n  \u2502\n  \u25bc\nMemoryOrchestrator.remember()\n  \u2502\n  \u251c\u2500 Chunk text (ChunkingStrategy)\n  \u2502\n  \u251c\u2500 Embed chunks (EmbeddingProvider.embed(batch:))\n  \u2502\n  \u251c\u2500 WaxSession.put() \u2500\u2500\u25ba Wax.putFrame() \u2500\u2500\u25ba WAL\n  \u2502\n  \u251c\u2500 FTS5SearchEngine.index() \u2500\u2500\u25ba SQLite FTS5\n  \u2502\n  \u251c\u2500 VectorEngine.add() \u2500\u2500\u25ba HNSW / Metal buffer\n  \u2502\n  \u2514\u2500 WaxSession.commit() \u2500\u2500\u25ba TOC + Footer + Header\n"})}),"\n",(0,i.jsx)(n.h3,{id:"retrieval-recall",children:"Retrieval (recall)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"User query\n  \u2502\n  \u25bc\nMemoryOrchestrator.recall()\n  \u2502\n  \u251c\u2500 Embed query (if vector search enabled)\n  \u2502\n  \u25bc\nFastRAGContextBuilder.build()\n  \u2502\n  \u251c\u2500 SearchRequest (unified search)\n  \u2502   \u251c\u2500 BM25 lane (FTS5SearchEngine.search())\n  \u2502   \u251c\u2500 Vector lane (VectorEngine.search())\n  \u2502   \u251c\u2500 Structured memory lane (entity/fact queries)\n  \u2502   \u2514\u2500 Timeline lane (reverse chronological fallback)\n  \u2502\n  \u251c\u2500 RRF fusion (AdaptiveFusionConfig per QueryType)\n  \u2502\n  \u251c\u2500 Intent-aware reranking\n  \u2502\n  \u251c\u2500 Token budget assembly\n  \u2502   \u251c\u2500 Expansion (first result, up to expansionMaxTokens)\n  \u2502   \u251c\u2500 Surrogates (tier-selected: full/gist/micro)\n  \u2502   \u2514\u2500 Snippets (remaining budget)\n  \u2502\n  \u2514\u2500 RAGContext (items + totalTokens)\n"})}),"\n",(0,i.jsx)(n.h2,{id:"readwrite-multiplexing",children:"Read/Write Multiplexing"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"WaxSession"})," abstracts the difference between read-only and read-write access:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Read-only sessions"})," can search and read frames concurrently"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Read-write sessions"})," acquire a writer lease from the underlying ",(0,i.jsx)(n.code,{children:"Wax"})," actor"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Multiple read-only sessions can operate simultaneously. Only one read-write session can be active at a time, controlled by the ",(0,i.jsx)(n.code,{children:"WaxSession.WriterPolicy"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"persistence-model",children:"Persistence Model"}),"\n",(0,i.jsxs)(n.p,{children:["All data flows through the ",(0,i.jsx)(n.code,{children:".mv2s"})," file:"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Frame payloads"})," are written to the WAL first (crash-safe)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Text indexes"})," are serialized as SQLite blobs stored in the TOC's segment catalog"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Vector indexes"})," are serialized in the MV2V format stored in the TOC's segment catalog"]}),"\n",(0,i.jsxs)(n.li,{children:["A ",(0,i.jsx)(n.strong,{children:"commit"})," flushes the WAL, writes the updated TOC and footer, and updates the header"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"This single-file design makes backups, transfers, and atomic operations straightforward."})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},8453(e,n,r){r.d(n,{R:()=>d,x:()=>c});var t=r(6540);const i={},s=t.createContext(i);function d(e){const n=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:d(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);